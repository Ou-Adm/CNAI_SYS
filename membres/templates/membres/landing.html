{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clever Nest AI - Universe</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #020202;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            color: white;
            user-select: none;
            cursor: crosshair;
            touch-action: none;
        }

        #scene-container {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        /* PRELOADER */
        #loader {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: #020202;
            z-index: 9999;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            transition: opacity 0.5s ease-out;
        }
        
        .loader-bar-container {
            width: 200px; 
            height: 4px; 
            background: rgba(255,255,255,0.1);
            border-radius: 4px; 
            margin-top: 20px; 
            overflow: hidden;
        }
        .loader-bar {
            width: 0%; 
            height: 100%; 
            background: #a855f7;
            transition: width 0.1s linear; 
            box-shadow: 0 0 10px #a855f7;
        }
        .loader-text {
            color: #a855f7; 
            font-size: 0.8rem; 
            letter-spacing: 2px;
            text-transform: uppercase; 
            font-weight: 600;
        }

        /* UI LAYER */
        .ui-layer {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            z-index: 10; 
            pointer-events: none;
            display: flex; 
            flex-direction: column; 
            justify-content: flex-end; 
            align-items: center;
            padding-bottom: 60px;
            transition: opacity 0.5s ease; 
            opacity: 0;
        }

        .hint-text {
            position: absolute; 
            top: 30px;
            font-size: 0.7rem; 
            letter-spacing: 2px; 
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.4);
            animation: pulseText 3s infinite;
            text-align: center;
            padding: 0 20px;
        }
        @keyframes pulseText { 
            0%, 100% { opacity: 0.3; } 
            50% { opacity: 0.8; } 
        }

        .btn-enter {
            pointer-events: auto;
            background: rgba(168, 85, 247, 0.15); 
            border: 1px solid rgba(168, 85, 247, 0.4);
            color: #e9d5ff; 
            padding: 16px 45px;
            font-family: 'Outfit', sans-serif; 
            font-size: 0.9rem; 
            font-weight: 600; 
            letter-spacing: 3px;
            border-radius: 4px; 
            backdrop-filter: blur(5px); 
            cursor: pointer;
            transition: all 0.3s ease; 
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }
        .btn-enter:hover {
            background: rgba(168, 85, 247, 0.8); 
            color: white;
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.5); 
            transform: translateY(-2px);
        }

        /* MODAL INFO */
        .info-modal {
            position: fixed; 
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%; 
            max-width: 400px;
            background: rgba(10, 10, 12, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #a855f7;
            padding: 30px;
            z-index: 100;
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            opacity: 0; 
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            text-align: left;
        }
        .info-modal.active { 
            opacity: 1; 
            transform: translate(-50%, -50%) scale(1); 
            pointer-events: auto; 
        }

        .modal-header {
            display: flex; 
            align-items: center; 
            gap: 20px; 
            margin-bottom: 20px;
        }
        .tech-icon-large {
            width: 60px; 
            height: 60px; 
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(168, 85, 247, 0.3));
        }

        .modal-close {
            position: absolute; 
            top: 10px; 
            right: 15px;
            background: none; 
            border: none; 
            color: #666;
            cursor: pointer; 
            font-size: 1.5rem; 
            line-height: 1;
        }
        .modal-close:hover { color: white; }

        .tech-year { 
            font-size: 0.75rem; 
            color: #a855f7; 
            font-weight: 700; 
            letter-spacing: 1px; 
            display: block; 
            margin-bottom: 2px;
        }
        .tech-title { 
            font-size: 2rem; 
            font-weight: 800; 
            color: white; 
            line-height: 1; 
        }
        
        .tech-meta { 
            font-size: 0.85rem; 
            color: #ccc; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
        }
        .tech-desc { 
            font-size: 0.95rem; 
            color: #9ca3af; 
            line-height: 1.6; 
        }

        /* OVERLAY DE TRANSITION */
        .transition-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: radial-gradient(circle, #1a0a2e 0%, #000000 100%);
            z-index: 999; 
            opacity: 0; 
            pointer-events: none;
            transition: opacity 0.4s ease-in-out;
        }
        .transition-overlay.active {
            opacity: 1;
        }

        /* GYRO INDICATOR (Mobile) */
        .gyro-hint {
            position: absolute;
            bottom: 120px;
            font-size: 0.65rem;
            color: rgba(168, 85, 247, 0.6);
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .gyro-hint.visible {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-text">INITIALISATION SYST√àME</div>
        <div class="loader-bar-container">
            <div class="loader-bar" id="progressBar"></div>
        </div>
    </div>

    <div id="scene-container"></div>
    
    <div class="ui-layer" id="uiLayer">
        <div class="hint-text">Cliquez sur un √©l√©ment pour l'analyser</div>
        <div class="gyro-hint" id="gyroHint">üì± Bougez votre t√©l√©phone</div>
        <button class="btn-enter" id="enterBtn">Acc√©der au Hub</button>
    </div>

    <div class="info-modal" id="infoModal">
        <button class="modal-close" onclick="closeModal()">√ó</button>
        
        <div class="modal-header">
            <img id="mLogo" src="" alt="Tech Logo" class="tech-icon-large">
            <div>
                <span class="tech-year" id="mYear"></span>
                <h2 class="tech-title" id="mTitle"></h2>
            </div>
        </div>

        <div class="tech-meta">Cr√©√© par <span id="mCreator" style="color:white"></span></div>
        <p class="tech-desc" id="mDesc"></p>
    </div>

    <div class="transition-overlay" id="transOverlay"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        const TECH_DB = [
            { key: 'python', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg', title: 'Python', year: '1991', creator: 'Guido van Rossum', desc: 'Langage leader de l\'IA et du Backend (Django).' },
            { key: 'js', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/javascript/javascript-original.svg', title: 'JavaScript', year: '1995', creator: 'Brendan Eich', desc: 'Le moteur du Web moderne et interactif.' },
            { key: 'react', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/react/react-original.svg', title: 'React', year: '2013', creator: 'Meta', desc: 'Biblioth√®que UI incontournable pour le frontend.' },
            { key: 'node', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/nodejs/nodejs-original.svg', title: 'Node.js', year: '2009', creator: 'Ryan Dahl', desc: 'JavaScript c√¥t√© serveur, rapide et scalable.' },
            { key: 'tensorflow', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/tensorflow/tensorflow-original.svg', title: 'TensorFlow', year: '2015', creator: 'Google', desc: 'Plateforme ML pour entra√Æner des r√©seaux de neurones.' },
            { key: 'arduino', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/arduino/arduino-original.svg', title: 'Arduino', year: '2005', creator: 'Ivrea Institute', desc: 'Microcontr√¥leurs pour la robotique et l\'IoT.' },
            { key: 'docker', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/docker/docker-original.svg', title: 'Docker', year: '2013', creator: 'Solomon Hykes', desc: 'Standard mondial pour la conteneurisation.' },
            { key: 'git', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/git/git-original.svg', title: 'Git', year: '2005', creator: 'Linus Torvalds', desc: 'Syst√®me de versioning essentiel.' },
            { key: 'linux', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/linux/linux-original.svg', title: 'Linux', year: '1991', creator: 'Linus Torvalds', desc: 'Le noyau qui propulse serveurs et supercalculateurs.' },
            { key: 'aws', url: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/amazonwebservices/amazonwebservices-original-wordmark.svg', title: 'AWS', year: '2006', creator: 'Amazon', desc: 'Leader du Cloud Computing.' }
        ];

        const isMobile = window.innerWidth < 768;
        const CONFIG = {
            particleCount: isMobile ? 400 : 800,
            bgHex: 0x020202,
            camZ: isMobile ? 18 : 15, 
            logoRadius: isMobile ? 5 : 7 
        };

        let scene, camera, renderer, particles;
        let logos = [], neuronLines = [];
        let raycaster, mouse;
        let isTransitioning = false, isPaused = false;
        let transitionSpeed = 0;
        let targetRotationX = 0, targetRotationY = 0;
        let container;
        let gyroPermission = false;
        let gyroAlpha = 0, gyroBeta = 0, gyroGamma = 0;

        // D√âTECTION ET DEMANDE GYROSCOPE (iOS 13+)
        function requestGyroPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            enableGyro();
                        }
                    })
                    .catch(console.error);
            } else if (window.DeviceOrientationEvent) {
                enableGyro();
            }
        }

        function enableGyro() {
            gyroPermission = true;
            window.addEventListener('deviceorientation', handleOrientation);
            document.getElementById('gyroHint').classList.add('visible');
        }

        function handleOrientation(e) {
            if (!gyroPermission || isTransitioning || isPaused) return;
            
            gyroAlpha = e.alpha || 0;
            gyroBeta = e.beta || 0;
            gyroGamma = e.gamma || 0;

            // Conversion en rotation de sc√®ne
            targetRotationY = (gyroGamma / 90) * 0.5;
            targetRotationX = ((gyroBeta - 45) / 90) * 0.3;
        }

        function init() {
            const manager = new THREE.LoadingManager();
            let loadedCount = 0;
            const totalToLoad = TECH_DB.length + 1; // Logos + Logo central
            
            manager.onProgress = function (item, loaded, total) {
                loadedCount++;
                const progress = (loadedCount / totalToLoad) * 100;
                document.getElementById('progressBar').style.width = Math.min(progress, 100) + '%';
            };
            
            manager.onLoad = function () {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => { 
                    loader.style.display = 'none';
                    container.style.opacity = '1';
                    document.getElementById('uiLayer').style.opacity = '1';
                    
                    // Activer gyro sur mobile
                    if (isMobile) {
                        setTimeout(requestGyroPermission, 500);
                    }
                }, 300);
            };

            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.bgHex);
            scene.fog = new THREE.FogExp2(CONFIG.bgHex, 0.035);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.z = CONFIG.camZ;

            renderer = new THREE.WebGLRenderer({ 
                antialias: !isMobile, 
                powerPreference: "high-performance",
                alpha: false
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile ? 1.5 : 2));
            
            container = document.getElementById('scene-container');
            container.appendChild(renderer.domElement);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            const textureLoader = new THREE.TextureLoader(manager);
            const centralUrl = "{% static 'membres/images/new_l.png' %}";
            
            textureLoader.load(centralUrl, (tex) => {
                const aspect = tex.image.width / tex.image.height;
                const mat = new THREE.MeshBasicMaterial({ 
                    map: tex, 
                    transparent: true, 
                    opacity: 0.95, 
                    side: THREE.DoubleSide 
                });
                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(3 * aspect, 3), mat);
                scene.add(mesh);
            }, undefined, () => {
                const geo = new THREE.IcosahedronGeometry(1.5, 0);
                const mat = new THREE.MeshBasicMaterial({ color: 0xa855f7, wireframe: true });
                scene.add(new THREE.Mesh(geo, mat));
            });

            createParticles();
            createOrbitalSystem(textureLoader);

            window.addEventListener('resize', onWindowResize);
            
            if (!isMobile) {
                document.addEventListener('mousemove', onMouseMove);
            }
            
            document.addEventListener('click', onMouseClick);
            document.addEventListener('touchstart', onTouchStart);
            document.getElementById('enterBtn').addEventListener('click', startTransition);
            
            animate();
        }

        function createParticles() {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(CONFIG.particleCount * 3);
            for(let i = 0; i < CONFIG.particleCount * 3; i++) {
                pos[i] = (Math.random() - 0.5) * 60;
            }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ 
                size: isMobile ? 0.08 : 0.06, 
                color: 0xffffff, 
                transparent: true, 
                opacity: 0.3 
            });
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
        }

        function createOrbitalSystem(loader) {
            let loadedLogos = 0;
            TECH_DB.forEach((item, i) => {
                loader.load(item.url, (tex) => {
                    const mat = new THREE.MeshBasicMaterial({ 
                        map: tex, 
                        transparent: true, 
                        opacity: 0.85 
                    });
                    const mesh = new THREE.Mesh(new THREE.PlaneGeometry(1.2, 1.2), mat);
                    
                    const r = CONFIG.logoRadius; 
                    const phi = Math.acos(-1 + (2 * i) / TECH_DB.length);
                    const theta = Math.sqrt(TECH_DB.length * Math.PI) * phi;

                    mesh.position.set(
                        r * Math.cos(theta) * Math.sin(phi),
                        r * Math.sin(theta) * Math.sin(phi),
                        r * Math.cos(phi)
                    );
                    
                    mesh.lookAt(0, 0, 0);
                    mesh.userData = { id: i, info: item };
                    
                    scene.add(mesh);
                    logos.push(mesh);

                    loadedLogos++;
                    if(loadedLogos === TECH_DB.length) {
                        updateLines();
                    }
                });
            });
        }

        function updateLines() {
            neuronLines.forEach(l => scene.remove(l));
            neuronLines = [];
            
            for(let i = 0; i < logos.length; i++) {
                let neighbors = [];
                for(let j = 0; j < logos.length; j++) {
                    if(i === j) continue;
                    const dist = logos[i].position.distanceTo(logos[j].position);
                    neighbors.push({id: j, dist: dist});
                }
                neighbors.sort((a, b) => a.dist - b.dist);
                
                for(let k = 0; k < Math.min(2, neighbors.length); k++) {
                    const target = logos[neighbors[k].id];
                    if(neighbors[k].dist < 6) {
                        const pts = [logos[i].position, target.position];
                        const geo = new THREE.BufferGeometry().setFromPoints(pts);
                        const mat = new THREE.LineBasicMaterial({ 
                            color: 0xa855f7, 
                            transparent: true, 
                            opacity: 0.15 
                        });
                        const line = new THREE.Line(geo, mat);
                        scene.add(line);
                        neuronLines.push(line);
                    }
                }
            }
        }

        function onMouseMove(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            if(!isTransitioning) {
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(logos);
                
                document.body.style.cursor = intersects.length > 0 ? 'pointer' : 'crosshair';
            }

            if(!isTransitioning && !isPaused && !gyroPermission) {
                targetRotationY = mouse.x * 0.2;
                targetRotationX = mouse.y * 0.2;
            }
        }

        function onTouchStart(e) {
            if (e.target.closest('.info-modal') || e.target.closest('.btn-enter')) return;
            
            const touch = e.touches[0];
            mouse.x = (touch.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(touch.clientY / window.innerHeight) * 2 + 1;
        }

        function onMouseClick(event) {
            if(isTransitioning) return;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(logos);

            if (intersects.length > 0) {
                openModal(intersects[0].object.userData.info);
            } else {
                if(isPaused && !event.target.closest('.info-modal')) closeModal();
            }
        }

        function openModal(data) {
            isPaused = true;
            document.getElementById('mLogo').src = data.url;
            document.getElementById('mYear').innerText = data.year;
            document.getElementById('mTitle').innerText = data.title;
            document.getElementById('mCreator').innerText = data.creator;
            document.getElementById('mDesc').innerText = data.desc;
            
            document.getElementById('infoModal').classList.add('active');
            gsap.to('#uiLayer', { opacity: 0, duration: 0.3 });
        }

        window.closeModal = function() {
            isPaused = false;
            document.getElementById('infoModal').classList.remove('active');
            gsap.to('#uiLayer', { opacity: 1, duration: 0.3 });
        }

        function startTransition() {
            if(isPaused) closeModal();
            isTransitioning = true;
            
            // Transition imm√©diate et fluide
            gsap.to('#uiLayer', { opacity: 0, duration: 0.3 });
            
            setTimeout(() => {
                document.getElementById('transOverlay').classList.add('active');
            }, 200);
            
            // Redirection rapide (1.2s au lieu de potentiellement plus long)
            setTimeout(() => {
                window.location.href = "{% url 'index' %}";
            }, 1200);
        }

        function animate() {
            requestAnimationFrame(animate);

            if (!isTransitioning) {
                if(!isPaused) {
                    scene.rotation.y += 0.0015; 
                    scene.rotation.y += (targetRotationY - scene.rotation.y) * 0.05;
                    scene.rotation.x += (targetRotationX - scene.rotation.x) * 0.05;
                }
                logos.forEach(mesh => mesh.lookAt(camera.position));
            } else {
                // Animation de transition acc√©l√©r√©e
                transitionSpeed += 0.035;
                camera.position.z -= transitionSpeed;
                scene.rotation.z -= 0.03;
            }
            
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>