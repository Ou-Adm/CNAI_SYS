{% extends 'membres/base.html' %}
{% load static %}

{% block content %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    /* --- 1. CONFIGURATION G√âN√âRALE --- */
    :root {
        --glass-bg: rgba(22, 22, 27, 0.7);
        --glass-border: rgba(255, 255, 255, 0.08);
        --accent: #667eea;
        --accent-hover: #5a67d8;
        --success: #10b981;
        --error: #ef4444;
    }

    .scan-page-wrapper {
        min-height: 100vh;
        width: 100%;
        background: #000;
        /* Image de fond subtile ou d√©grad√© si tu veux, ici noir pur pro */
        background-image: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #000 60%);
        
        /* PADDING IMPORTANT POUR √âVITER LE CHEVAUCHEMENT NAVBAR */
        padding-top: 100px; 
        padding-bottom: 40px;
        padding-left: 20px;
        padding-right: 20px;
        box-sizing: border-box;
        
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Aligne en haut pour √©viter le centrage vertical g√™nant sur petit √©cran */
    }

    .scan-dashboard {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr; /* PC : Cam√©ra plus large que contr√¥les */
        gap: 25px;
        width: 100%;
        max-width: 1100px;
    }

    /* --- RESPONSIVE MOBILE (Passage en colonne) --- */
    @media (max-width: 900px) {
        .scan-dashboard {
            grid-template-columns: 1fr; /* Une seule colonne */
        }
        .scan-page-wrapper {
            padding-top: 85px; /* Un peu moins haut sur mobile */
            padding-left: 15px;
            padding-right: 15px;
        }
        /* Sur mobile, on veut que l'ordre soit : Cam√©ra d'abord, contr√¥les ensuite */
        .card-camera { order: 1; }
        .card-controls { order: 2; }
    }

    /* --- 2. STYLE DES CARTES (GLASSMORPHISM) --- */
    .dashboard-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 25px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        display: flex;
        flex-direction: column;
    }

    /* --- 3. ZONE CAM√âRA --- */
    .card-camera {
        position: relative;
        overflow: hidden;
        min-height: 350px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .camera-frame {
        width: 100%;
        height: 100%;
        border-radius: 16px;
        overflow: hidden;
        background: #000;
        border: 2px solid #333;
        position: relative;
        aspect-ratio: 4/3; /* Ratio standard vid√©o */
    }
    
    #reader { width: 100%; height: 100%; object-fit: cover; }
    
    /* Animation Laser */
    .laser-scan {
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 2px;
        background: rgba(102, 126, 234, 0.8);
        box-shadow: 0 0 15px #667eea;
        z-index: 5;
        animation: scanAnim 3s infinite linear;
        display: none; /* Cach√© par d√©faut */
    }
    .camera-frame.active .laser-scan { display: block; }

    @keyframes scanAnim {
        0% { top: 10%; opacity: 0; }
        50% { opacity: 1; }
        100% { top: 90%; opacity: 0; }
    }

    /* Overlay Start */
    .start-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.85);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        cursor: pointer;
        transition: 0.3s;
    }
    .start-overlay:hover { background: rgba(0,0,0,0.7); }
    .start-icon {
        width: 70px; height: 70px;
        background: var(--accent);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 30px rgba(102, 126, 234, 0.4);
        margin-bottom: 15px;
    }

    /* --- 4. ZONE CONTR√îLES --- */
    .card-controls h2 {
        font-size: 20px; font-weight: 700; color: white; margin-bottom: 20px;
        border-bottom: 1px solid var(--glass-border); padding-bottom: 15px;
    }

    .control-group { margin-bottom: 20px; }
    .control-label {
        display: block; color: #a0aec0; font-size: 13px; font-weight: 600;
        margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
    }

    .modern-select, .modern-input {
        width: 100%;
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--glass-border);
        color: white;
        padding: 14px;
        border-radius: 12px;
        font-size: 15px;
        outline: none;
        transition: 0.3s;
    }
    .modern-select:focus, .modern-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); }
    .modern-select option { background: #111; color: white; }

    /* Switch Tabs */
    .mode-switch {
        display: flex;
        background: rgba(0,0,0,0.3);
        padding: 5px;
        border-radius: 12px;
        border: 1px solid var(--glass-border);
    }
    .mode-btn {
        flex: 1;
        padding: 10px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        color: #718096;
        font-weight: 600;
        transition: 0.3s;
    }
    .mode-btn.active {
        background: var(--accent);
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Bouton Action */
    .action-btn {
        width: 100%;
        padding: 16px;
        background: var(--accent);
        color: white;
        font-weight: 800;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        transition: 0.2s;
        margin-top: 10px;
    }
    .action-btn:hover { background: var(--accent-hover); }
    .action-btn:active { transform: scale(0.98); }

    /* Status Dot */
    .status-indicator {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        margin-top: auto; padding-top: 20px;
        font-size: 13px; color: #718096;
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
    .dot.active { background: var(--success); box-shadow: 0 0 10px var(--success); }

    /* --- 5. POPUPS --- */
    /* Succ√®s - Centr√©, Moderne */
    .popup-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
        z-index: 9990; display: none;
    }
    
    .popup-card {
        position: fixed; top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: #18181b;
        border: 1px solid rgba(255,255,255,0.1);
        padding: 40px 30px;
        border-radius: 30px;
        text-align: center;
        z-index: 9999;
        width: 90%; max-width: 380px;
        box-shadow: 0 25px 80px rgba(0,0,0,0.8);
        display: none; opacity: 0;
        transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .popup-card.show { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
    
    .success-ring {
        width: 80px; height: 80px; margin: 0 auto 20px;
        border-radius: 50%; border: 4px solid rgba(16, 185, 129, 0.2);
        display: flex; align-items: center; justify-content: center;
    }
    .success-icon { width: 40px; height: 40px; color: var(--success); }

    .popup-name { font-size: 24px; font-weight: 700; color: white; margin-bottom: 5px; }
    .popup-sub { font-size: 16px; color: var(--success); font-weight: 600; margin-bottom: 15px; }
    .popup-badge { background: #222; padding: 5px 12px; border-radius: 20px; color: #aaa; font-size: 13px; }

    /* Erreur - Toast haut */
    .error-toast {
        position: fixed; top: 110px; left: 50%; transform: translateX(-50%) translateY(-20px);
        background: #3f1515; border: 1px solid #ef4444; color: #fca5a5;
        padding: 12px 24px; border-radius: 50px; font-weight: 600;
        z-index: 10000; opacity: 0; transition: 0.3s; pointer-events: none;
    }
    .error-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

</style>

<div class="scan-page-wrapper">
    
    <audio id="snd-success" src="{% static 'membres/sounds/succes.mp3' %}" preload="auto"></audio>
    <audio id="snd-error" src="{% static 'membres/sounds/error.mp3' %}" preload="auto"></audio>

    <div class="scan-dashboard">
        
        <div class="dashboard-card card-camera">
            <div id="camera-frame" class="camera-frame">
                <div class="laser-scan"></div>
                
                <div id="start-overlay" class="start-overlay" onclick="initScanner()">
                    <div class="start-icon">
                        <svg style="width:32px;height:32px;color:white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 style="color:white; font-weight:700; font-size:18px;">Activer le Scanner</h3>
                </div>
                
                <div id="reader"></div>
            </div>
            
            <div class="status-indicator">
                <div id="status-dot" class="dot"></div>
                <span id="status-text">Scanner en pause</span>
            </div>
        </div>

        <div class="dashboard-card card-controls">
            <h2>Param√®tres</h2>

            <div class="control-group">
                <label class="control-label">√âv√©nement en cours</label>
                <select id="evenement" class="modern-select">
                    <option value="">-- S√©lectionner --</option>
                    {% for evt in evenements %}
                        <option value="{{ evt.id }}">{{ evt.titre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Mode de saisie</label>
                <div class="mode-switch">
                    <div id="tab-cam" class="mode-btn active" onclick="switchMode('cam')">Cam√©ra</div>
                    <div id="tab-man" class="mode-btn" onclick="switchMode('man')">Manuel</div>
                </div>
            </div>

            <div id="manual-zone" class="control-group" style="display: none;">
                <label class="control-label">Code UUID</label>
                <input type="text" id="uuid_input" class="modern-input" placeholder="Coller le code ici..." autocomplete="off">
                <button class="action-btn" onclick="manualSubmit()">Valider le Code</button>
            </div>

            <div style="margin-top: auto; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px;">
                <p style="font-size: 13px; color: #718096; line-height: 1.4;">
                    Assurez-vous de s√©lectionner l'√©v√©nement avant de scanner. Les points seront ajout√©s automatiquement.
                </p>
            </div>
        </div>

    </div>
</div>

<div id="popup-overlay" class="popup-overlay"></div>

<div id="success-popup" class="popup-card">
    <div class="success-ring">
        <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
    </div>
    <div id="popup-name" class="popup-name">Nom √âtudiant</div>
    <div id="popup-info" class="popup-sub">+ Points</div>
    <div class="popup-badge">Scan Valid√©</div>
</div>

<div id="error-toast" class="error-toast">Erreur inconnue</div>

<script>
    const sndSuccess = document.getElementById('snd-success');
    const sndError = document.getElementById('snd-error');
    
    let html5QrCode = null;
    let isScanning = false;
    let soundUnlocked = false;

    // --- 1. INITIALISATION ---
    function initScanner() {
        if (!soundUnlocked) {
            sndSuccess.play().then(() => { sndSuccess.pause(); sndSuccess.currentTime = 0; }).catch(()=>{});
            sndError.play().then(() => { sndError.pause(); sndError.currentTime = 0; }).catch(()=>{});
            soundUnlocked = true;
        }
        document.getElementById('start-overlay').style.display = 'none';
        startCamera();
    }

    // --- 2. CAM√âRA ---
    function startCamera() {
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        
        html5QrCode = new Html5Qrcode("reader");

        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, ()=>{})
        .then(() => {
            updateStatus(true, "Scanner Actif ‚Ä¢ En attente de code");
            document.querySelector('.camera-frame').classList.add('active'); // Active le laser
            isScanning = true;
        })
        .catch(err => {
            updateStatus(false, "Erreur Cam√©ra");
            showError("Cam√©ra inaccessible");
        });
    }

    function updateStatus(active, text) {
        document.getElementById('status-text').innerText = text;
        const dot = document.getElementById('status-dot');
        if(active) dot.classList.add('active'); else dot.classList.remove('active');
    }

    // --- 3. TRAITEMENT SCAN ---
    function onScanSuccess(decodedText) {
        if (!isScanning) return;

        const evtId = document.getElementById('evenement').value;
        if (!evtId) {
            showError("‚ö†Ô∏è S√©lectionnez un √©v√©nement √† droite !");
            return;
        }

        pauseSystem();

        fetch("{% url 'scan_qr_code' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ uuid_code: decodedText, evenement_id: parseInt(evtId) })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.data);
            } else {
                showError(data.message);
                setTimeout(resumeSystem, 2500);
            }
        })
        .catch(() => {
            showError("Erreur serveur");
            setTimeout(resumeSystem, 2500);
        });
    }

    function pauseSystem() {
        html5QrCode.pause();
        isScanning = false;
        document.querySelector('.camera-frame').classList.remove('active');
        updateStatus(true, "Analyse en cours...");
    }

    function resumeSystem() {
        try { 
            html5QrCode.resume(); 
            isScanning = true;
            document.querySelector('.camera-frame').classList.add('active');
            updateStatus(true, "Scanner Actif");
        } catch(e) {}
    }

    // --- 4. FEEDBACK VISUEL & SONORE ---
    function showSuccess(data) {
        sndSuccess.currentTime = 0; sndSuccess.play().catch(e=>{});

        document.getElementById('popup-name').innerText = data.nom;
        let info = `+${data.points_gaines || 0} Points`;
        if(data.nouveau_certificat) info = "üéì CERTIFICAT OBTENU !";
        document.getElementById('popup-info').innerText = info;

        // Afficher Popup
        document.getElementById('popup-overlay').style.display = 'block';
        const popup = document.getElementById('success-popup');
        popup.classList.add('show');

        setTimeout(() => {
            popup.classList.remove('show');
            document.getElementById('popup-overlay').style.display = 'none';
            resumeSystem();
        }, 2000);
    }

    function showError(msg) {
        if(soundUnlocked) { sndError.currentTime = 0; sndError.play().catch(e=>{}); }
        
        const toast = document.getElementById('error-toast');
        toast.innerText = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // --- 5. LOGIQUE INTERFACE ---
    window.switchMode = function(mode) {
        // UI Tabs
        document.getElementById('tab-cam').classList.toggle('active', mode==='cam');
        document.getElementById('tab-man').classList.toggle('active', mode==='man');

        if(mode === 'cam') {
            document.getElementById('manual-zone').style.display = 'none';
            // Si le scanner √©tait d√©marr√©, on le resume
            if(html5QrCode && !isScanning) try{ html5QrCode.resume(); isScanning=true; } catch(e){}
        } else {
            document.getElementById('manual-zone').style.display = 'block';
            if(html5QrCode && isScanning) try{ html5QrCode.pause(); isScanning=false; } catch(e){}
        }
    }

    window.manualSubmit = function() {
        const code = document.getElementById('uuid_input').value;
        if(!code) return showError("Le code est vide");
        onScanSuccess(code); // On r√©utilise la m√™me fonction
    }

    function getCookie(name) {
        if (!document.cookie) return null;
        const xsrf = document.cookie.split('; ').find(row => row.startsWith(name + '='));
        return xsrf ? decodeURIComponent(xsrf.split('=')[1]) : null;
    }
</script>
{% endblock %}